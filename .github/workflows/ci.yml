name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Ruff linter
        run: ruff check .

      - name: Run Ruff formatter check
        run: ruff format --check .

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run mypy
        run: mypy harvest

  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/ -v --tb=short

  validate-schema:
    name: Validate JSON Schema
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install jsonschema
        run: pip install jsonschema

      - name: Validate schema is valid JSON Schema
        run: |
          python -c "
          import json
          from jsonschema import Draft202012Validator

          with open('data/schema/catalog.schema.json') as f:
              schema = json.load(f)

          # Check schema is valid
          Draft202012Validator.check_schema(schema)
          print('Schema is valid JSON Schema Draft 2020-12')
          "

      - name: Validate catalog.json if exists
        run: |
          if [ -f "public/catalog.json" ]; then
            python -c "
          import json
          from jsonschema import validate, Draft202012Validator

          with open('data/schema/catalog.schema.json') as f:
              schema = json.load(f)

          with open('public/catalog.json') as f:
              catalog = json.load(f)

          for i, entry in enumerate(catalog):
              validate(entry, schema)

          print(f'Validated {len(catalog)} catalog entries')
          "
          else
            echo "No catalog.json found, skipping validation"
          fi
